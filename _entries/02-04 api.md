---
sectionid: ratingsapi
sectionclass: h2
title: ratings APIのデプロイ
parent-id: lab-ratingapp
---

サンプルのrating-apiは、mongoDBに接続してアイテムを取得および評価するNodeJSアプリケーションです。これを展開するために必要な情報を以下に示します。

- GitHub: <https://github.com/microsoft/rating-api>
- コンテナは8080ポートを使用します
- MongoDBへの接続は、環境変数`MONGODB_URI`を使用します。 

### Fork the application to your own GitHub repository

To be able to setup CI/CD webhooks, you'll need to fork the application into your personal GitHub repository.

<a class="github-button" href="https://github.com/microsoft/rating-api/fork" data-icon="octicon-repo-forked" data-size="large" aria-label="Fork microsoft/rating-api on GitHub">Fork</a>

### Use the OpenShift CLI to deploy the `rating-api`

> **Note** You're going to be using [source-to-image (S2I)](#source-to-image-s2i) as a build strategy.

{% collapsible %}

```sh
oc new-app https://github.com/<your GitHub username>/rating-api --strategy=source
```

![Create rating-api using oc cli](media/oc-newapp-ratingapi.png)

{% endcollapsible %}

### 必要な環境変数を設定します

{% collapsible %}

Create the `MONGODB_URI` environment variable. This URI should look like `mongodb://[username]:[password]@[endpoint]:27017/ratingsdb`. You'll need to replace the `[usernaame]` and `[password]` with the ones you used when creating the database. You'll also need to replace the `[endpoint]` with the hostname acquired in the previous step
環境変数 `MONGODB_URI` を作成します。このURIは次のようになります。
mongodb://[username]:[password]@[endpoint]:27017/ratingsdb

データベースを作成したときに使用したときの`usernaame` `password` `endpoint` に値を書き換えます。

完了したら[Save]をクリックします。

![Create a MONGODB_URI environment variable](media/rating-api-envvars.png)

{% endcollapsible %}

### サービスの稼働確認

{% collapsible %}

`rating-api` Deploymentのログに移動すると、コードがmongoDBに正常に接続できることを確認するログメッセージが表示されます。

![Verify mongoDB connection](media/rating-api-working.png)

{% endcollapsible %}

### `rating-api` サービスのホスト名を取得する

{% collapsible %}

`rating-api` サービスを確認します。

```sh
oc get svc rating-api
```

サービスはポート8080のDNS名でアクセスできるようになります。
rating-api.workshop.svc.cluster.local:8080
この `[service name].[project name].svc.cluster.local` はクラスタ内でのみ名前解決されます。

{% endcollapsible %}

### Setup GitHub webhook

To trigger S2I builds when you push code into your GitHib repo, you'll need to setup the GitHub webhook.

{% collapsible %}

Retrieve the GitHub webhook trigger secret. You'll need use this secret in the GitHub webhook URL.

```sh
oc get bc/rating-api -o=jsonpath='{.spec.triggers..github.secret}'
```

You'll get back something similar to the below. Make note the secret key in the red box as you'll need it in a few steps.

![Rating API GitHub trigger secret](media/rating-api-github-secret.png)

Retrieve the GitHub webhook trigger URL from the build configuration.

```sh
oc describe bc/rating-api
```

![Rating API GitHub trigger url](media/rating-api-github-webhook-url.png)

Replace the `<secret>` placeholder with the secret you retrieved in the previous step to have a URL similar to `https://openshift.9729df58f18c47bab789.eastus.azmosa.io:443/apis/build.openshift.io/v1/namespaces/workshop/buildconfigs/rating-api/webhooks/1inS0TVIN-Zw92xxtIXr/github`. You'll use this URL to setup the webhook on your GitHub repository.

In your GitHub repository, select **Add Webhook** from **Settings** → **Webhooks**.

Paste the URL output (similar to above) into the Payload URL field.

Change the Content Type from GitHub’s default **application/x-www-form-urlencoded** to **application/json**.

Click **Add webhook**.

![GitHub add webhook](media/rating-api-github-addwebhook.png)

You should see a message from GitHub stating that your webhook was successfully configured.

Now, whenever you push a change to your GitHub repository, a new build will automatically start, and upon a successful build a new deployment will start.

{% endcollapsible %}

> **Resources**
> * [ARO Documentation - Creating Images with S2I](https://docs.openshift.com/aro/creating_images/s2i.html)
> * [ARO Documentation - Triggering builds](https://docs.openshift.com/aro/dev_guide/builds/triggering_builds.html)